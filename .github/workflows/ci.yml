# Unified CI: lint → build & test (artifacts) → on success: docker, gRPC schema, clients (downloadable)
# Version is incremented on each merge to main.
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ---- 1) Version (only on main): compute next version for this run ----
  version:
    name: Bump version
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Read and bump version
        id: bump
        run: |
          if [ -f VERSION ]; then
            ver=$(cat VERSION)
          else
            ver=$(grep '^version' Cargo.toml | head -1 | sed 's/.*= *"\(.*\)".*/\1/')
          fi
          echo "current=$ver" >> $GITHUB_OUTPUT
          major=$(echo "$ver" | cut -d. -f1)
          minor=$(echo "$ver" | cut -d. -f2)
          patch=$(echo "$ver" | cut -d. -f3)
          patch=$((patch + 1))
          new_version="${major}.${minor}.${patch}"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "$new_version" > VERSION
      - name: Upload VERSION for release
        uses: actions/upload-artifact@v4
        with:
          name: version-file
          path: VERSION

  # ---- 2) Lint first ----
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy, cargo
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-stable-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-stable-lint-

      - name: Buf Validate (gRPC schema)
        uses: bufbuild/buf-action@v1
        with:
          push: false

      - name: Check code formatting
        run: cargo fmt --all -- --check

      - name: Run clippy (code smells check)
        run: |
          cargo clippy --version
          cargo clippy --all-targets --all-features -- -D warnings \
            -D clippy::dbg_macro \
            -D clippy::print_stdout \
            -D clippy::print_stderr \
            -D clippy::todo \
            -D clippy::unimplemented \
            -D clippy::panic \
            -D clippy::exit \
            -D clippy::cast_lossless \
            -D clippy::cast_possible_truncation \
            -D clippy::cast_possible_wrap \
            -D clippy::cast_precision_loss \
            -D clippy::cast_sign_loss \
            -D clippy::clone_on_ref_ptr \
            -D clippy::empty_enums \
            -D clippy::enum_glob_use \
            -D clippy::if_not_else \
            -D clippy::mut_mut \
            -D clippy::non_ascii_literal \
            -D clippy::single_match_else \
            -D clippy::string_add \
            -D clippy::string_add_assign \
            -D clippy::string_lit_as_bytes \
            -D clippy::unnecessary_unwrap \
            -D clippy::unused_self \
            -D clippy::useless_let_if_seq \
            -A clippy::module_name_repetitions \
            -A clippy::must_use_candidate \
            -A clippy::missing_errors_doc \
            -A clippy::missing_panics_doc \
            -A clippy::too_many_lines \
            -A clippy::similar_names \
            -A clippy::inline_always \
            -A clippy::unwrap_used \
            -A clippy::expect_used \
            -A clippy::panic \
            -A unused_imports \
            -A unused_macros \
            -A dead_code

      - name: Check documentation builds
        run: cargo doc --no-deps --all-features --document-private-items

  # ---- 3) Test (only if lint succeeds) ----
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint]
    strategy:
      matrix:
        rust: [stable]
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy, cargo
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.rust }}-

      - name: Run tests
        run: cargo test --verbose --all-features

  # ---- 4) Build and publish binary artifacts (downloadable in GH) ----
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    needs: [lint, test]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: cargo
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-stable-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-stable-

      - name: Build release
        run: cargo build --verbose --release --all-features

      - name: Prepare bin artifacts (named by OS and arch to avoid release conflicts)
        shell: bash
        run: |
          mkdir -p staging
          OS="$RUNNER_OS"
          ARCH="${RUNNER_ARCH:-X64}"
          case "$ARCH" in
            X64)   ARCH_FN=x86_64 ;;
            ARM64) ARCH_FN=aarch64 ;;
            X86)   ARCH_FN=x86 ;;
            ARM)   ARCH_FN=arm ;;
            *)     ARCH_FN="$ARCH" ;;
          esac
          case "$OS" in
            Linux)  OS_FN=linux ;;
            Windows) OS_FN=windows ;;
            macOS)  OS_FN=macos ;;
            *)      OS_FN="$OS" ;;
          esac
          for bin in fingerprinting-agent fingerprinting-light-agent; do
            if [ "$OS" = "Windows" ]; then
              [ -f "target/release/${bin}.exe" ] && cp "target/release/${bin}.exe" "staging/${bin}-${OS_FN}-${ARCH_FN}.exe"
            else
              [ -f "target/release/${bin}" ] && cp "target/release/${bin}" "staging/${bin}-${OS_FN}-${ARCH_FN}"
            fi
          done
          (cd staging && ls -la)

      - name: Upload bin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bins-${{ matrix.os }}
          path: staging/
          if-no-files-found: error

  # ---- 5) If build success: publish Docker image ----
  publish-docker:
    name: Publish Docker image
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build, version]
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log into registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ needs.version.outputs.new_version }},enable=${{ true }}
            type=raw,value=latest,enable=${{ true }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---- 6) If build success: publish gRPC schema (Buf) ----
  publish-schema:
    name: Publish gRPC schema
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build]
    steps:
      - uses: actions/checkout@v4
      - name: Buf push
        uses: bufbuild/buf-action@v1
        with:
          push: true
        env:
          BUF_TOKEN: ${{ secrets.BUF_TOKEN }}

  # ---- 7) If build success: generate clients and make them downloadable ----
  generate-clients:
    name: Generate clients
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          setup_only: true
      - run: buf generate
      - name: Package Go client
        run: |
          mkdir -p dist
          (cd clients/go && zip -r ../../dist/clients-go.zip .)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: temurin
      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'SETTINGS'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          SETTINGS
      - name: Package and publish Java client to GitHub Maven
        run: |
          cd clients/java && mvn -q clean deploy -DskipTests
          cd ../..
          mkdir -p dist
          cp clients/java/target/*.jar dist/ 2>/dev/null || true
          (cd clients/java/target && zip -r ../../../dist/clients-java.zip *.jar) 2>/dev/null || true
      - name: Package and publish Kotlin client to GitHub Maven
        run: |
          cd clients/kotlin && mvn -q clean deploy -DskipTests
          cd ../..
          (cd clients/kotlin/target && zip -r ../../../dist/clients-kotlin.zip *.jar) 2>/dev/null || true
      - name: Upload client artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-clients
          path: dist/

  # ---- 8) Create GitHub Release with bins + clients (downloadable) ----
  release:
    name: Create release
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [build, generate-clients, version]
    permissions:
      contents: write
    steps:
      - name: Download version file
        uses: actions/download-artifact@v4
        with:
          name: version-file
      - name: Get version
        id: ver
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT
      - name: Download all bin artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bins-*
          path: bins
      - name: Download client artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-clients
          path: clients-dist
      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: v${{ steps.ver.outputs.version }}
          generate_release_notes: true
          files: |
            bins/**/*
            clients-dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ---- 9) Commit version bump back to repo (on each merge to main) ----
  commit-version-bump:
    name: Commit version bump
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [release]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download version file
        uses: actions/download-artifact@v4
        with:
          name: version-file
      - name: Sync version to Cargo.toml and client poms
        run: |
          ver=$(cat VERSION)
          # Update workspace.package version
          sed -i.bak "s/^version = .*/version = \"$ver\"/" Cargo.toml
          rm -f Cargo.toml.bak
          # Update clients/java/pom.xml and clients/kotlin/pom.xml (first <version> only)
          sed -i.bak "1,/^\s*<version>/ s/^\(\s*\)<version>[^<]*<\/version>/\1<version>$ver<\/version>/" clients/java/pom.xml
          sed -i.bak "1,/^\s*<version>/ s/^\(\s*\)<version>[^<]*<\/version>/\1<version>$ver<\/version>/" clients/kotlin/pom.xml
          rm -f clients/java/pom.xml.bak clients/kotlin/pom.xml.bak
      - name: Commit and push version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION Cargo.toml clients/java/pom.xml clients/kotlin/pom.xml
          git diff --staged --quiet || git commit -m "chore: bump version to $(cat VERSION) [skip ci]"
          git push
